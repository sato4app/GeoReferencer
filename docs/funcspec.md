# GeoReferencer 機能仕様書

## 1. 概要

GeoReferencerは、PNG画像（ハイキングマップなど）を国土地理院の地理院地図上にジオリファレンス（地理的位置合わせ）する専用Webアプリケーションです。GPS座標データとPNG画像を読み込み、画像を正確な地理的位置に重ね合わせることができます。

## 2. システム要件

### 2.1 動作環境
- **ブラウザ**: Chrome、Firefox、Safari、Edge（最新版推奨）
- **JavaScript**: ES6モジュール対応
- **サーバー**: ローカルHTTPサーバー（CORS制限回避のため）
- **必要なサーバーコマンド**: `python -m http.server 8000` または `npx serve .`

### 2.2 外部依存関係
- **Leaflet.js** v1.9.4: 地図レンダリング
- **SheetJS** v0.18.5: Excelファイル読み込み（将来拡張用）
- **国土地理院タイル**: 地図データソース

## 3. 主要機能

### 3.1 ファイル読み込み機能

#### 3.1.1 ポイントGPS読み込み（GeoJSON）
- **対応形式**: GeoJSON (.json)
- **データ内容**: GPS座標ポイントデータ
- **表示**: 赤色の円形マーカー（半径6px）
- **レイヤー**: `pointJsonMarkers`（z-index: 620）

#### 3.1.2 PNG画像読み込み
- **対応形式**: PNG画像ファイル
- **用途**: ハイキングマップなどの重ね合わせ対象画像
- **初期表示**: 箕面大滝付近を中心とした初期境界で表示

#### 3.1.3 画像内座標読み込み（JSON）
- **対応形式**: JSON (.json、複数ファイル対応)
- **データ種別**: ポイント、ルート、スポットデータ
- **自動分類**: ファイル内容に基づく自動判定

### 3.2 マーカー表示機能

#### 3.2.1 ポイントマーカー
- **通常ポイント**: 赤色円形マーカー（半径6px）
- **ルート開始点**: 緑色円形マーカー（半径7px）
- **ルート終了点**: 赤色円形マーカー（半径7px）
- **ルート中間点**: オレンジ色ダイヤモンド型マーカー（8×8px）

#### 3.2.2 スポットマーカー
- **形状**: 正方形（10×10px）
- **色**: 青色（#0066ff）
- **境界**: 濃い青色（#004499）の1px境界線
- **レイヤー**: `pointJsonMarkers`

#### 3.2.3 ポップアップ表示
- **ポイント**: 名前、座標情報
- **ルートポイント**: ルート名、ラベル（開始点/終了点/中間点）、座標
- **スポット**: 名前、ファイル名、座標

### 3.3 ジオリファレンス機能

#### 3.3.1 精密アフィン変換
- **アルゴリズム**: 最小二乗法による6パラメータアフィン変換
- **使用ポイント**: 全一致ポイント（制限なし）
- **精度評価**: 平均誤差、最大誤差の算出
- **変換行列**: 2×3行列による座標変換

#### 3.3.2 自動位置同期
- **対象**: ポイント、ルート、スポットマーカー
- **同期条件**: 画像座標由来（`origin: 'image'`）のマーカーのみ
- **GPS由来マーカー**: 移動対象外（位置維持）
- **変換適用**: リアルタイムでマーカー位置を更新

#### 3.3.3 画像重ね合わせ実行
- **トリガー**: 「画像の重ね合わせ（ジオリファレンス）」ボタン
- **処理フロー**:
  1. 対応ポイントペアの抽出
  2. アフィン変換パラメータ計算
  3. 画像位置・スケール・回転の適用
  4. マーカー位置の自動更新

### 3.4 座標変換・出力機能

#### 3.4.1 GeoJSON出力
- **フォーマット**: GeoJSON Feature Collection
- **含まれるデータ**: 
  - 変換後のポイント座標
  - ルート情報（マーカーのみ、線なし）
  - スポット情報
- **ファイル名**: `georeferenced-points.json`

#### 3.4.2 座標系対応
- **入力座標系**: WGS84（GPS座標）
- **表示座標系**: Web Mercator（Leaflet標準）
- **変換**: 画像座標 ↔ GPS座標の双方向変換

## 4. データ形式仕様

### 4.1 GeoJSONポイントデータ
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [経度, 緯度]
      },
      "properties": {
        "name": "ポイント名",
        "id": "識別子"
      }
    }
  ]
}
```

### 4.2 ルートデータ
```json
{
  "name": "ルート名",
  "routeInfo": {
    "startPoint": "開始点ID",
    "endPoint": "終了点ID"
  },
  "points": [
    {
      "id": "point1",
      "name": "ポイント名",
      "lat": 緯度,
      "lng": 経度,
      "type": "waypoint",
      "imageX": 画像X座標,
      "imageY": 画像Y座標
    }
  ]
}
```

### 4.3 スポットデータ
```json
{
  "spots": [
    {
      "name": "スポット名",
      "imageX": 画像X座標,
      "imageY": 画像Y座標,
      "lat": 緯度,
      "lng": 経度
    }
  ]
}
```

## 5. UIコンポーネント仕様

### 5.1 メインパネル
- **ファイル読み込み**: ラジオボタンによる種類選択
- **カウンター表示**: ポイント、ルート、スポットの読み込み数
- **実行ボタン**: ジオリファレンス処理の実行
- **出力ボタン**: GeoJSON形式での結果出力

### 5.2 地図表示
- **ベースマップ**: 国土地理院地形図
- **初期位置**: 箕面大滝（34.853667, 135.472041）
- **初期ズーム**: 14レベル
- **レイヤー管理**: 専用ペインによるz-index制御

### 5.3 レイヤー構成
- `tilePane`: 地形図タイル（z-index: 200）
- `overlayPane`: 画像オーバーレイ（z-index: 400）
- `shadowPane`: マーカー影（z-index: 500）
- `markerPane`: デフォルトマーカー（z-index: 600）
- `gpsMarkers`: GPSマーカー（z-index: 610）
- `pointJsonMarkers`: ポイント・スポットマーカー（z-index: 620）
- `wayPointMarkers`: 中間点マーカー（z-index: 630）
- `tooltipPane`: ツールチップ（z-index: 650）
- `popupPane`: ポップアップ（z-index: 700）

## 6. エラーハンドリング

### 6.1 ファイル読み込みエラー
- **対応形式外**: 適切なエラーメッセージ表示
- **ファイル破損**: JSON解析エラーのハンドリング
- **個別ファイルエラー**: 他ファイル処理継続

### 6.2 ジオリファレンスエラー
- **対応点不足**: 最小必要点数の確認
- **変換精度低下**: 警告メッセージの表示
- **計算エラー**: フォールバック処理

### 6.3 ログ機能
- **ログレベル**: ERROR、WARN、INFO、DEBUG
- **保存先**: LocalStorage（最大1000件）
- **フォーマット**: タイムスタンプ付きJSON形式

## 7. パフォーマンス仕様

### 7.1 処理制限
- **Excel行数制限**: 1000行（将来拡張用）
- **ファイルサイズ**: ブラウザ制限に依存
- **同時マーカー数**: 実用的制限なし

### 7.2 メモリ管理
- **画像キャッシュ**: ブラウザネイティブ機能活用
- **マーカー管理**: Leafletレイヤーシステム活用
- **ログローテーション**: 自動的な古いログ削除

## 8. セキュリティ仕様

### 8.1 ファイル検証
- **MIME type**: 厳密な形式チェック
- **ファイルサイズ**: ブラウザ制限内
- **コンテンツ検証**: JSON構造の妥当性確認

### 8.2 XSS対策
- **入力サニタイゼーション**: HTMLエスケープ処理
- **CSP**: Content Security Policy適用検討
- **信頼できないスクリプト実行**: 制限

## 9. 今後の拡張予定

### 9.1 機能拡張
- **Excel直接読み込み**: .xlsxファイル対応
- **複数画像対応**: 複数PNG画像の同時処理
- **高精度変換**: より高次の幾何変換アルゴリズム

### 9.2 UI改善
- **ドラッグ&ドロップ**: ファイル読み込みの簡素化
- **プログレスバー**: 処理進捗の可視化
- **設定保存**: ユーザー設定の永続化

## 10. 技術アーキテクチャ

### 10.1 モジュール構成
- `app-main.js`: メインアプリケーション制御
- `map-core.js`: 地図初期化・レイヤー管理
- `gps-data.js`: GPS・GeoJSONデータ処理
- `image-overlay.js`: 画像重ね合わせ処理
- `georeferencing.js`: ジオリファレンス計算
- `route-spot-handler.js`: ルート・スポット管理
- `coordinate-display.js`: 座標表示制御
- `ui-handlers.js`: UI操作ハンドラー
- `utils.js`: ユーティリティ・ログ機能

### 10.2 設計パターン
- **ES6モジュール**: 機能分離とカプセル化
- **イベント駆動**: UI操作とデータ処理の分離
- **非同期処理**: Promise/async-awaitパターン
- **エラーファースト**: 堅牢なエラーハンドリング

---

最終更新: 2024年09月
バージョン: 1.0.0