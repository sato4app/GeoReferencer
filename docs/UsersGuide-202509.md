# GeoReferencer 利用者の手引（2025年9月版）

## 目次
1. [はじめに](#1-はじめに)
2. [動作環境](#2-動作環境)
3. [アプリケーションの起動](#3-アプリケーションの起動)
4. [基本的な使い方](#4-基本的な使い方)
5. [ファイルの準備](#5-ファイルの準備)
6. [操作手順](#6-操作手順)
7. [GeoJSON出力の詳細](#7-geojson出力の詳細)
8. [トラブルシューティング](#8-トラブルシューティング)
9. [よくある質問](#9-よくある質問)
10. [制限事項](#10-制限事項)

## 1. はじめに

### 1.1 GeoReferencerとは
GeoReferencerは、PNG画像（ハイキングマップなど）を国土地理院の地理院地図上に精密にジオリファレンス（地理的位置合わせ）することを専門とするWebアプリケーションです。最小二乗法による6パラメータアフィン変換技術を用いて、高精度な画像位置合わせを実現し、地理的に正確なGeoJSONデータを生成します。

### 1.2 主な用途
- **ハイキングマップの地理的位置合わせ**
- **古い地図や手描き地図の現代地図への重ね合わせ**
- **GPS座標データと画像座標の統合**
- **地理的に正確なGeoJSONデータの生成**
- **GISアプリケーション用データの作成**

### 1.3 技術的特徴
- **完全ES6モジュール構成**（13ファイル、モジュラーアーキテクチャ）
- **精密アフィン変換**（最小二乗法による6パラメータ変換）
- **File System Access API対応**（モダンブラウザでのネイティブ保存）
- **GeoJSON仕様準拠**（3つのFeatureタイプ対応）

### 1.4 このガイドについて
この手引では、GeoReferencerの基本的な使い方から、実際のデータ処理、出力データの活用まで、ステップバイステップで説明します。初めてお使いになる方でも、順序立てて操作できるよう構成されています。

## 2. 動作環境

### 2.1 必要なブラウザ
- **Chrome** 61以降（推奨、File System Access API対応は86以降）
- **Firefox** 60以降
- **Safari** 10.1以降
- **Edge** 79以降

### 2.2 システム要件
- **JavaScript**: ES6モジュール対応ブラウザ
- **インターネット接続**: 地図データの読み込みに必要
- **ローカルサーバー**: CORS制限回避のため必須

### 2.3 推奨スペック
- **メモリ**: 4GB以上
- **ディスク容量**: 処理するファイルサイズの3倍以上の空き容量
- **ネットワーク**: 安定したインターネット接続

## 3. アプリケーションの起動

### 3.1 ファイルのダウンロード
GeoReferencerプロジェクトファイルを適切なフォルダにダウンロード・展開してください。

### 3.2 ローカルサーバーの起動
ブラウザのCORS制限を回避するため、必ずローカルサーバーを起動してください。

#### Pythonを使用する場合
```bash
# プロジェクトフォルダに移動
cd GeoReferencer

# Python 3の場合
python -m http.server 8000

# Python 2の場合
python -m SimpleHTTPServer 8000
```

#### Node.jsを使用する場合
```bash
# プロジェクトフォルダに移動
cd GeoReferencer

# serve パッケージを使用
npx serve .
```

### 3.3 ブラウザでのアクセス
ローカルサーバー起動後、ブラウザで以下のURLにアクセスしてください：
```
http://localhost:8000
```

### 3.4 初期画面の確認
正常に起動すると、以下の画面が表示されます：
- **地図エリア**: 国土地理院地図（箕面大滝周辺）
- **左上の制御パネル**: ファイル読み込みボタンやカウンター表示
- **右下のコントロール**: ズーム・スケールコントロール

## 4. 基本的な使い方

### 4.1 処理の流れ
GeoReferencerでの一般的な作業の流れは以下の通りです：

1. **GPS座標データの読み込み**（Excel/GeoJSON形式）
2. **PNG画像ファイルの読み込み**
3. **画像内座標データの読み込み**（JSON形式、複数ファイル対応）
4. **ジオリファレンス（画像重ね合わせ）の実行**
5. **結果の確認と調整**
6. **GeoJSONファイルの出力**

### 4.2 インターフェースの説明

#### 制御パネル（左上）
- **統合ファイル読み込み**: ラジオボタンでGPS/画像を選択
- **読み込みボタン**: 選択したファイル種類の読み込み実行
- **画像内座標読み込み**: JSONファイルの読み込み（複数選択可能）
- **リアルタイムカウンター**: 読み込み済みデータの数量表示
- **ジオリファレンスボタン**: 画像重ね合わせの実行
- **GPS出力ボタン**: GeoJSONファイルのダウンロード

#### 地図エリア
- **国土地理院地図**: ベースマップとして表示
- **5層レイヤー構造**: z-index制御による適切な表示順序
- **マーカー表示**: GPS座標、画像座標、ルート、スポットの色分け表示
- **画像オーバーレイ**: 読み込んだPNG画像の半透明重ね合わせ表示

#### マーカー表示仕様
- **GPSポイント**: 緑色円形（半径16px）
- **ポイントマーカー**: 赤色円形（半径6px）
- **ルート中間点**: オレンジ色ダイヤモンド型（8×8px）
- **スポットマーカー**: 青色正方形（12×12px）

## 5. ファイルの準備

### 5.1 GPS座標データ

#### Excel形式の場合
**必須列**
| 列名 | 内容 | 例 |
|------|------|-----|
| ポイントID | 一意識別子 | A-01 |
| 名称 | ポイント名 | 展望台 |
| 緯度 | WGS84緯度 | 34.853667 |
| 経度 | WGS84経度 | 135.472041 |

**オプション列**
| 列名 | 内容 | 例 |
|------|------|-----|
| 標高 | 標高（メートル） | 420 |
| 備考 | 追加情報 | 休憩ポイント |

**注意事項**
- **ファイル形式**: .xlsx形式のみ対応
- **最大行数**: 1000行まで
- **座標系**: WGS84（緯度経度）のみ対応
- **文字コード**: UTF-8推奨

#### GeoJSON形式の場合
標準的なGeoJSON FeatureCollection形式に対応：
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "id": "A-01",
        "name": "展望台"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [135.472041, 34.853667]
      }
    }
  ]
}
```

### 5.2 PNG画像ファイル

#### 要件
- **ファイル形式**: PNG形式のみ
- **推奨サイズ**: 10MB以下
- **解像度**: 制限なし（ただし、高解像度ほど処理時間が長くなります）

#### 推奨事項
- **画質**: 可能な限り高画質
- **コントラスト**: 地形や道路が明瞭に識別できるもの
- **ファイル名**: 日本語対応（出力ファイル名に使用されます）

### 5.3 画像内座標データ（JSON形式）
GeoReferencerは複数のJSONファイルを同時に読み込み、内容を自動判定します。

#### ポイントデータ形式
```json
{
  "points": [
    {
      "id": "A-01",
      "imageX": 150,
      "imageY": 200,
      "name": "展望台"
    }
  ]
}
```

#### ルートデータ形式
```json
{
  "routeInfo": {
    "name": "登山道",
    "startPoint": "A-01",
    "endPoint": "A-05"
  },
  "points": [
    {
      "type": "waypoint",
      "imageX": 150,
      "imageY": 200
    }
  ]
}
```

#### スポットデータ形式
```json
{
  "spots": [
    {
      "name": "休憩所",
      "imageX": 300,
      "imageY": 400,
      "description": "ベンチあり"
    }
  ]
}
```

## 6. 操作手順

### 6.1 Step 1: GPS座標データの読み込み

1. **ファイル種類の選択**: 「ポイントGPS」ラジオボタンを選択（デフォルト）
2. **読み込み実行**: 「読み込み」ボタンをクリック
3. **ファイル選択**: Excel（.xlsx）またはGeoJSONファイルを選択
4. **結果確認**:
   - 左上のカウンターで読み込み件数を確認
   - 地図上に緑色の円形マーカー（半径16px）が表示されることを確認
   - マーカーをクリックすると詳細情報がポップアップ表示

### 6.2 Step 2: PNG画像の読み込み

1. **ファイル種類の選択**: 「PNG画像」ラジオボタンを選択
2. **読み込み実行**: 「読み込み」ボタンをクリック
3. **ファイル選択**: PNG画像ファイルを選択
4. **結果確認**:
   - 地図上に半透明（50%透過）の画像が表示されることを確認
   - 初期位置は地図中心（箕面大滝）に配置されます
   - 画像境界の自動計算が実行されます

### 6.3 Step 3: 画像内座標データの読み込み

1. **読み込み実行**: 「画像内座標の読み込み」ボタンをクリック
2. **ファイル選択**: JSONファイル（複数選択可能）を選択
3. **自動判定処理**: アプリケーションが自動的に以下を実行
   - ファイル内容の構造解析
   - ポイント・ルート・スポットの自動分類
   - 重複データの除去
4. **結果確認**:
   - カウンターで各データ種別の件数を確認
   - 地図上に種別ごとの色分けされたマーカーが表示されることを確認
   - 各マーカーをクリックして詳細情報を確認

#### 自動判定されるデータ種別
- **ポイント**: 赤色円形マーカー（半径6px）
- **ルート中間点**: オレンジ色ダイヤモンド型マーカー（8×8px）
- **スポット**: 青色正方形マーカー（12×12px）

### 6.4 Step 4: ジオリファレンス（画像重ね合わせ）の実行

1. **前提条件の確認**:
   - GPS座標データが読み込まれている
   - PNG画像が読み込まれている
   - 画像内座標データが読み込まれている
   - 最低3点以上の制御点（GPS座標と画像内座標でIDが一致するポイント）が存在する

2. **実行**: 「画像の重ね合わせ（ジオリファレンス）」ボタンをクリック

3. **自動処理**: アプリケーションが自動的に以下を実行
   - **IDマッチング**: GPS座標と画像内座標のポイントID照合
   - **制御点検証**: 最小点数（3点）と分布の確認
   - **座標変換**: WGS84 → Web Mercator変換
   - **アフィン変換計算**: 最小二乗法による6パラメータ算出
   - **精度評価**: 平均誤差・最大誤差・最小誤差の計算
   - **位置同期**: 画像位置とマーカー位置の自動調整

4. **結果確認**:
   - 処理完了メッセージの表示
   - 精度情報の表示（平均誤差、最大誤差、使用制御点数）
   - 一致ポイント数・不一致ポイント一覧の表示
   - 画像が正確な地理的位置に移動していることを確認
   - 画像由来マーカーの位置が自動調整されることを確認

### 6.5 Step 5: 結果の確認と調整

#### 精度の確認
- **平均誤差**: 10メートル以下が推奨
- **最大誤差**: 50メートル以下が理想的
- **使用制御点数**: 4点以上が推奨（最低3点）
- **制御点分布**: 画像全体に分散していることが重要

#### 調整が必要な場合
- **制御点の追加**: より多くの一致ポイントを準備
- **制御点の精度向上**: GPS座標の再測定・確認
- **画像品質の改善**: より高解像度・高コントラストの画像を使用
- **制御点分布の改善**: 画像の四隅に近い位置への制御点追加

### 6.6 Step 6: GeoJSONファイルの出力

1. **出力実行**: 「GPS出力(GeoJSON)」ボタンをクリック
2. **データ収集**: アプリケーションが自動的に以下を実行
   - ポイントGPSデータの収集（Excel「名称」列を優先使用）
   - ルート中間点データの収集（route_{開始}_to_{終了}_waypoint_XX形式）
   - スポットデータの収集（spot{XX}_{名前}形式）
3. **保存処理**:
   - File System Access API対応ブラウザ: ネイティブ保存ダイアログ
   - 従来ブラウザ: ダウンロードフォルダへの自動保存
4. **ファイル名**: `{PNG名}-GPS.geojson` 形式で自動生成

## 7. GeoJSON出力の詳細

### 7.1 出力データ仕様
GeoReferencerは`docs/dataspec-geojson.md`に準拠した3つのFeatureタイプを出力します：

#### 1. ポイントGPS
```json
{
  "type": "Feature",
  "properties": {
    "id": "J-05",
    "name": "東海道自然歩道",
    "type": "ポイントGPS",
    "source": "GPS_Excel",
    "description": "緊急ポイント（Excel管理GPS値）",
    "notes": ""
  },
  "geometry": {
    "type": "Point",
    "coordinates": [135.49331, 34.87202, 564.7]
  }
}
```

#### 2. ルート中間点
```json
{
  "type": "Feature",
  "properties": {
    "id": "route_C-03_to_J-01_waypoint_06",
    "name": "waypoint_06",
    "type": "route_waypoint",
    "source": "image_transformed",
    "route_id": "route_C-03_to_J-01",
    "description": "ルート中間点"
  },
  "geometry": {
    "type": "Point",
    "coordinates": [135.49353, 34.86449]
  }
}
```

#### 3. スポット
```json
{
  "type": "Feature",
  "properties": {
    "id": "spot08_薬師堂",
    "name": "薬師堂",
    "type": "spot",
    "source": "image_transformed",
    "description": "スポット"
  },
  "geometry": {
    "type": "Point",
    "coordinates": [135.49052, 34.86557]
  }
}
```

### 7.2 データソース分類
- **GPS_Excel**: Excelファイルから読み込まれた実測GPS座標
- **image_transformed**: 画像からジオリファレンス変換された座標

### 7.3 座標精度
- **座標系**: WGS84（EPSG:4326）
- **精度**: 小数点以下5桁（約1.1m精度）
- **標高**: 小数点以下1桁（約0.1m精度、オプション）

### 7.4 出力データの活用
- **GISソフトウェア**: QGIS、ArcGIS等での表示・解析
- **Web地図**: Leaflet、OpenLayers等での表示
- **モバイルアプリ**: GPS追跡アプリでの利用
- **データ連携**: 他のアプリケーションとのデータ交換

## 8. トラブルシューティング

### 8.1 アプリケーションが起動しない

#### 症状
- ブラウザで白い画面が表示される
- JavaScript エラーが表示される
- 地図が読み込まれない

#### 対処法
1. **ローカルサーバーの確認**: `http://localhost:8000`でアクセスしているか確認
2. **ブラウザの確認**: ES6モジュール対応ブラウザを使用しているか確認
3. **コンソールエラーの確認**: F12でデベロッパーツールを開き、エラーメッセージを確認
4. **ファイルパスの確認**: プロジェクトファイルが正しい場所に配置されているか確認
5. **インターネット接続**: 地図タイルの読み込みに必要

### 8.2 ファイルが読み込めない

#### Excel ファイルの問題
- **対応形式**: .xlsx形式のみ（.xls、.csvは未対応）
- **列名**: 必須列（ポイントID、名称、緯度、経度）が存在するか確認
- **データ形式**: 緯度・経度が数値形式で入力されているか確認
- **座標範囲**: 緯度（-90～90）、経度（-180～180）の範囲内か確認
- **行数制限**: 1000行以下に調整
- **文字コード**: UTF-8で保存されているか確認

#### PNG画像の問題
- **ファイル形式**: PNG形式のみ（JPEG、GIF等は未対応）
- **ファイルサイズ**: 10MB以下に調整
- **破損チェック**: 他のアプリケーションで画像が正常に開けるか確認
- **MIME type**: image/pngとして認識されるか確認

#### JSONファイルの問題
- **JSON形式**: 有効なJSON形式で記述されているか確認
- **必須フィールド**: 各データ種別の必須フィールドが含まれているか確認
- **座標値**: imageX、imageYが数値形式で入力されているか確認
- **文字エンコーディング**: UTF-8で保存されているか確認

### 8.3 ジオリファレンスがうまくいかない

#### 制御点不足
- **最小要件**: 3点以上の一致ポイント
- **推奨**: 4点以上、理想的には6点以上
- **分布**: 画像全体に分散して配置
- **マッチング**: GPS座標と画像内座標でポイントIDが完全一致

#### 座標精度の問題
- **GPS精度**: 10メートル以内の精度を確保
- **画像座標精度**: ピクセル単位での正確な位置指定
- **ID一致**: GPS データと画像内座標のポイントIDが完全に一致
- **座標系統一**: すべてのGPS座標がWGS84で統一

#### 計算エラー
- **共線性**: 制御点が一直線上に配置されていないか確認
- **重複**: 同一座標の制御点が複数ないか確認
- **特異行列**: 制御点の配置が不適切でないか確認
- **数値精度**: 座標値に十分な精度があるか確認

### 8.4 出力ファイルの問題

#### ダウンロードできない
- **ブラウザ設定**: ダウンロード許可設定を確認
- **セキュリティ**: ポップアップブロック設定を確認
- **File System Access API**: 対応ブラウザ（Chrome 86+）の場合、権限許可
- **ディスク容量**: 十分な空き容量があるか確認

#### ファイル内容の問題
- **座標精度**: 出力座標がWGS84形式になっているか確認
- **属性情報**: 必要なプロパティが含まれているか確認
- **GeoJSON形式**: 有効なGeoJSON形式で出力されているか確認
- **文字エンコーディング**: UTF-8で保存されているか確認

### 8.5 デバッグ機能の活用

#### ログ機能
- **ブラウザコンソール**: F12 → Console タブで詳細ログを確認
- **デバッグモード**: URLに`?debug=true`を追加でより詳細な情報
- **LocalStorageログ**: 最大1000件の操作履歴を保持

#### エラー情報の確認
- **エラーモーダル**: 画面に表示されるエラー内容を記録
- **ブラウザログ**: デベロッパーツールでより技術的な情報を確認
- **ネットワークタブ**: ファイル読み込みエラーの詳細を確認

## 9. よくある質問

### 9.1 一般的な質問

**Q: どのような画像が適していますか？**
A: ハイキングマップ、古地図、手描き地図など、地理的な特徴点（山頂、分岐点、建物等）が明確に識別できる画像が適しています。コントラストが高く、地形や道路が明瞭に見える高解像度画像を推奨します。

**Q: GPS座標はどの程度の精度が必要ですか？**
A: 10メートル以内の精度を推奨します。スマートフォンのGPSでも、晴天時の屋外であれば十分な精度が得られます。より高精度なGNSS受信機を使用すると、さらに良い結果が得られます。

**Q: 制御点は最低何点必要ですか？**
A: 最低3点ですが、精度向上のため4点以上を推奨します。画像の四隅に近い位置に分散して配置することが理想的です。6点以上あれば、より安定した変換が可能です。

**Q: Excel「名称」列の重要性は？**
A: 「名称」列の値が出力GeoJSONの`name`フィールドに使用されます。ポイントIDだけでなく、わかりやすい地点名を記載することで、出力データの可読性が向上します。

### 9.2 技術的な質問

**Q: 対応している座標系は何ですか？**
A: 入力・出力ともにWGS84（緯度経度）のみ対応しています。内部計算はWeb Mercator投影を使用し、最終的にWGS84に変換して出力します。

**Q: オフラインで使用できますか？**
A: 地図データ（国土地理院タイル）の読み込みにインターネット接続が必要です。完全オフラインでの使用はできませんが、一度地図を読み込んだ範囲は一時的にキャッシュされます。

**Q: スマートフォンで使用できますか？**
A: 技術的には可能ですが、画面サイズやファイル操作の制約により、PC/タブレットでの使用を推奨します。特に、複数ファイルの選択や詳細な座標確認にはある程度の画面サイズが必要です。

**Q: 変換精度を向上させるには？**
A: 以下の点に注意してください：①制御点を4点以上、画像全体に分散配置、②GPS座標の精度向上（10m以内）、③画像内座標の正確な位置指定、④制御点の適切な分布（一直線上に配置しない）。

### 9.3 データ処理に関する質問

**Q: 大量のデータを処理できますか？**
A: Excel データは最大1000行、PNG画像は10MB程度までを推奨します。それ以上のデータは分割して処理してください。メモリ使用量も考慮し、段階的に処理することをお勧めします。

**Q: 複数の画像を同時に処理できますか？**
A: 現在は1枚ずつの処理に対応しています。複数画像の場合は、個別に処理してください。各画像に対して独立したジオリファレンス処理が必要です。

**Q: 出力されたGeoJSONファイルの用途は？**
A: GISソフトウェア（QGIS、ArcGIS等）での表示・解析、Web地図サービスでの利用、モバイルGPSアプリでの表示、他のアプリケーションとのデータ連携等に使用できます。標準的なGeoJSON形式なので、多くのアプリケーションで利用可能です。

**Q: ルートとスポットの違いは？**
A: ルートは連続した経路（登山道など）を表し、開始点・終了点・中間点の情報を含みます。スポットは独立した地点（展望台、休憩所など）を表します。出力GeoJSONでは異なるFeatureタイプとして分類されます。

### 9.4 出力データに関する質問

**Q: 出力されるルートIDの形式は？**
A: `route_{開始ポイント}_to_{終了ポイント}` 形式で自動生成されます（例：`route_C-03_to_J-01`）。JSONファイルのrouteInfo.startPoint/endPointから取得されます。

**Q: GeoJSONの座標順序は？**
A: GeoJSON標準に従い、[経度, 緯度, 標高] の順序で出力されます。標高は存在する場合のみ含まれます。

**Q: データソース（source）フィールドの意味は？**
A: `GPS_Excel`は実測GPS座標、`image_transformed`は画像からジオリファレンス変換された座標を示します。データの信頼性や精度の参考にご利用ください。

## 10. 制限事項

### 10.1 ファイル形式の制限
- **画像**: PNG形式のみ（JPEG、SVG等は未対応）
- **Excel**: .xlsx形式のみ（.xls、.csv等は未対応）
- **座標系**: WGS84のみ（JGD2011、UTM等は未対応）
- **JSON**: UTF-8エンコーディング必須

### 10.2 サイズ・数量の制限
- **Excel行数**: 最大1000行
- **画像サイズ**: 推奨10MB以下
- **制御点数**: 最低3点、推奨4点以上
- **JSONファイル**: 複数ファイル対応だが、合計データ量に注意

### 10.3 ブラウザ・環境の制限
- **ES6モジュール**: 対応ブラウザ必須
- **CORS制限**: ローカルサーバー必須
- **インターネット接続**: 地図データ読み込みに必要
- **JavaScript**: 有効化必須

### 10.4 精度の制限
- **変換精度**: 制御点の精度と数に依存
- **適用範囲**: アフィン変換（線形変換）のため、非線形歪みは補正不可
- **座標系変換**: WGS84 ↔ Web Mercator間のみ
- **地図投影**: 広範囲の画像では投影歪みの影響を受ける可能性

### 10.5 機能の制限
- **画像編集**: 回転・スケール調整等の手動編集機能なし
- **座標系変換**: 自動座標系判定・変換機能なし
- **バッチ処理**: 複数画像の一括処理機能なし
- **アンドゥ機能**: 操作の取り消し機能なし

---

## 付録

### A. 参考リンク
- **国土地理院**: https://www.gsi.go.jp/
- **GeoJSON仕様**: https://geojson.org/
- **Leaflet.js**: https://leafletjs.com/
- **File System Access API**: https://developer.mozilla.org/docs/Web/API/File_System_Access_API

### B. サンプルデータ
プロジェクトには以下のサンプルデータが含まれています：
- **サンプルExcel**: GPS座標データのテンプレート
- **サンプルJSON**: ポイント・ルート・スポットデータの例
- **サンプル画像**: ジオリファレンス用テスト画像

### C. サポート情報
- **技術的質問**: プロジェクトのIssueトラッカーまでお寄せください
- **機能要望**: GitHub Issues で新機能のリクエストを受け付けています
- **バグ報告**: 詳細な再現手順とともにご報告ください

### D. 更新履歴
- **v1.0** (2025-09-12): 初版リリース
- **v1.1** (2025-09-20): リファクタリング版対応、操作性改善、精度向上
- **v1.2** (2025-09-28): GeoJSON出力仕様準拠、データソース分類実装、命名規則統一

---

*この利用者の手引は、GeoReferencer v1.2に基づいて作成されています。最新の機能仕様については、docs/funcspec-202509.mdをご参照ください。*