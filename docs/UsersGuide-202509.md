# GeoReferencer 利用者の手引（2025年9月版）

## 目次
1. [はじめに](#1-はじめに)
2. [動作環境](#2-動作環境)
3. [アプリケーションの起動](#3-アプリケーションの起動)
4. [基本的な使い方](#4-基本的な使い方)
5. [ファイルの準備](#5-ファイルの準備)
6. [操作手順](#6-操作手順)
7. [トラブルシューティング](#7-トラブルシューティング)
8. [よくある質問](#8-よくある質問)
9. [制限事項](#9-制限事項)

## 1. はじめに

### 1.1 GeoReferencerとは
GeoReferencerは、PNG画像（ハイキングマップなど）を国土地理院の地理院地図上に正確に重ね合わせる（ジオリファレンス）ための専用Webアプリケーションです。GPS座標データと画像内座標データを組み合わせて、精密なアフィン変換により地理的に正確な位置合わせを行います。

### 1.2 主な用途
- **ハイキングマップの地理的位置合わせ**
- **古い地図や手描き地図の現代地図への重ね合わせ**
- **GPS座標データと画像座標の統合**
- **地理的に正確なGeoJSONデータの生成**

### 1.3 このガイドについて
この手引では、GeoReferencerの基本的な使い方から、実際のデータ処理まで、ステップバイステップで説明します。初めてお使いになる方でも、順序立てて操作できるよう構成されています。

## 2. 動作環境

### 2.1 必要なブラウザ
- **Chrome** 61以降（推奨）
- **Firefox** 60以降
- **Safari** 10.1以降
- **Edge** 79以降

### 2.2 システム要件
- **JavaScript**: ES6モジュール対応ブラウザ
- **インターネット接続**: 地図データの読み込みに必要
- **ローカルサーバー**: CORS制限回避のため必須

### 2.3 推奨スペック
- **メモリ**: 4GB以上
- **ディスク容量**: 処理するファイルサイズの3倍以上の空き容量
- **ネットワーク**: 安定したインターネット接続

## 3. アプリケーションの起動

### 3.1 ファイルのダウンロード
GeoReferencerプロジェクトファイルを適切なフォルダにダウンロード・展開してください。

### 3.2 ローカルサーバーの起動
ブラウザのCORS制限を回避するため、必ずローカルサーバーを起動してください。

#### Pythonを使用する場合
```bash
# プロジェクトフォルダに移動
cd GeoReferencer

# Python 3の場合
python -m http.server 8000

# Python 2の場合
python -m SimpleHTTPServer 8000
```

#### Node.jsを使用する場合
```bash
# プロジェクトフォルダに移動
cd GeoReferencer

# serve パッケージを使用
npx serve .
```

### 3.3 ブラウザでのアクセス
ローカルサーバー起動後、ブラウザで以下のURLにアクセスしてください：
```
http://localhost:8000
```

### 3.4 初期画面の確認
正常に起動すると、以下の画面が表示されます：
- **地図エリア**: 国土地理院地図（箕面大滝周辺）
- **左上の制御パネル**: ファイル読み込みボタンやカウンター表示
- **右下のコントロール**: ズーム・スケールコントロール

## 4. 基本的な使い方

### 4.1 処理の流れ
GeoReferencerでの一般的な作業の流れは以下の通りです：

1. **GPS座標データの読み込み**（Excel形式）
2. **PNG画像ファイルの読み込み**
3. **画像内座標データの読み込み**（JSON形式）
4. **ジオリファレンス（画像重ね合わせ）の実行**
5. **結果の確認と調整**
6. **GeoJSONファイルの出力**

### 4.2 インターフェースの説明

#### 制御パネル（左上）
- **ファイル読み込み選択**: ラジオボタンでGPS/画像を選択
- **読み込みボタン**: 選択したファイル種類の読み込み実行
- **画像内座標読み込み**: JSONファイルの読み込み
- **カウンター表示**: 読み込み済みデータの数量表示
- **ジオリファレンスボタン**: 画像重ね合わせの実行
- **出力ボタン**: GeoJSONファイルのダウンロード

#### 地図エリア
- **国土地理院地図**: ベースマップとして表示
- **マーカー表示**: GPS座標、画像座標、ルート、スポットの表示
- **画像オーバーレイ**: 読み込んだPNG画像の重ね合わせ表示

## 5. ファイルの準備

### 5.1 GPS座標データ（Excel形式）

#### 必須列
| 列名 | 内容 | 例 |
|------|------|-----|
| ポイントID | 一意識別子 | A-01 |
| 名称 | ポイント名 | 展望台 |
| 緯度 | WGS84緯度 | 34.853667 |
| 経度 | WGS84経度 | 135.472041 |

#### オプション列
| 列名 | 内容 | 例 |
|------|------|-----|
| 標高 | 標高（メートル） | 420 |
| 備考 | 追加情報 | 休憩ポイント |

#### 注意事項
- **ファイル形式**: .xlsx形式のみ対応
- **最大行数**: 1000行まで
- **座標系**: WGS84（緯度経度）のみ対応
- **文字コード**: UTF-8推奨

### 5.2 PNG画像ファイル

#### 要件
- **ファイル形式**: PNG形式のみ
- **推奨サイズ**: 10MB以下
- **解像度**: 制限なし（ただし、高解像度ほど処理時間が長くなります）

#### 推奨事項
- **画質**: 可能な限り高画質
- **コントラスト**: 地形や道路が明瞭に識別できるもの
- **ファイル名**: 日本語対応（出力ファイル名に使用されます）

### 5.3 画像内座標データ（JSON形式）

#### ポイントデータ形式
```json
{
  "points": [
    {
      "id": "A-01",
      "imageX": 150,
      "imageY": 200,
      "name": "展望台"
    }
  ]
}
```

#### ルートデータ形式
```json
{
  "routeInfo": {
    "name": "登山道",
    "startPoint": "A-01",
    "endPoint": "A-05"
  },
  "points": [
    {
      "type": "waypoint",
      "imageX": 150,
      "imageY": 200
    }
  ]
}
```

#### スポットデータ形式
```json
{
  "spots": [
    {
      "name": "休憩所",
      "imageX": 300,
      "imageY": 400,
      "description": "ベンチあり"
    }
  ]
}
```

## 6. 操作手順

### 6.1 Step 1: GPS座標データの読み込み

1. **ファイル種類の選択**: 「ポイントGPS」ラジオボタンを選択
2. **読み込み実行**: 「読み込み」ボタンをクリック
3. **ファイル選択**: Excelファイル（.xlsx）を選択
4. **結果確認**:
   - 左上のカウンターで読み込み件数を確認
   - 地図上に緑色の円形マーカーが表示されることを確認

### 6.2 Step 2: PNG画像の読み込み

1. **ファイル種類の選択**: 「PNG画像」ラジオボタンを選択
2. **読み込み実行**: 「読み込み」ボタンをクリック
3. **ファイル選択**: PNG画像ファイルを選択
4. **結果確認**:
   - 地図上に半透明の画像が表示されることを確認
   - 初期位置は地図中心に配置されます

### 6.3 Step 3: 画像内座標データの読み込み

1. **読み込み実行**: 「画像内座標の読み込み」ボタンをクリック
2. **ファイル選択**: JSONファイル（複数選択可能）を選択
3. **結果確認**:
   - カウンターで各データ種別の件数を確認
   - 地図上に種別ごとの色分けされたマーカーが表示されることを確認

#### マーカーの色分け
- **ポイント**: 赤色円形
- **ルート開始点**: 緑色円形
- **ルート終了点**: 赤色円形
- **ルート中間点**: オレンジ色ダイヤモンド
- **スポット**: 青色正方形

### 6.4 Step 4: ジオリファレンス（画像重ね合わせ）の実行

1. **実行**: 「画像の重ね合わせ（ジオリファレンス）」ボタンをクリック
2. **処理待機**: 自動的に以下の処理が実行されます
   - GPS座標と画像内座標のポイントマッチング
   - 最小二乗法による精密アフィン変換計算
   - 画像位置の自動調整
   - 全座標の同期更新

3. **結果確認**:
   - 処理完了メッセージの表示
   - 精度情報（平均誤差、最大誤差）の表示
   - 一致ポイント数・不一致ポイント一覧の表示
   - 画像が正確な地理的位置に移動していることを確認

### 6.5 Step 5: 結果の確認と調整

#### 精度の確認
- **平均誤差**: 10メートル以下が推奨
- **最大誤差**: 50メートル以下が理想的
- **使用制御点数**: 4点以上が推奨

#### 調整が必要な場合
- **制御点の追加**: より多くの一致ポイントを準備
- **制御点の精度向上**: GPS座標の確認・修正
- **画像品質の改善**: より高解像度・高コントラストの画像を使用

### 6.6 Step 6: GeoJSONファイルの出力

1. **出力実行**: 「GPS出力(GeoJSON)」ボタンをクリック
2. **保存場所の選択**: ファイル保存ダイアログで保存先を選択
3. **ファイル名確認**: 自動生成される「{PNG名}-GPS.geojson」形式のファイル名を確認
4. **保存実行**: ファイルを保存

#### 出力データの内容
- **変換済みポイント座標**: アフィン変換適用済みのWGS84座標
- **元GPS座標**: 変換前の正確なGPS座標
- **ルート・スポット情報**: 画像由来データの地理的位置
- **メタデータ**: 座標の由来（GPS/画像）、変換情報

## 7. トラブルシューティング

### 7.1 アプリケーションが起動しない

#### 症状
- ブラウザで白い画面が表示される
- JavaScript エラーが表示される

#### 対処法
1. **ローカルサーバーの確認**: `http://localhost:8000`でアクセスしているか確認
2. **ブラウザの確認**: ES6モジュール対応ブラウザを使用しているか確認
3. **コンソールエラーの確認**: F12でデベロッパーツールを開き、エラーメッセージを確認
4. **ファイルパスの確認**: プロジェクトファイルが正しい場所に配置されているか確認

### 7.2 ファイルが読み込めない

#### Excel ファイルの問題
- **対応形式**: .xlsx形式のみ（.xls、.csvは未対応）
- **列名**: 必須列（ポイントID、名称、緯度、経度）が存在するか確認
- **データ形式**: 緯度・経度が数値形式で入力されているか確認
- **行数制限**: 1000行以下に調整

#### PNG画像の問題
- **ファイル形式**: PNG形式のみ（JPEG、GIF等は未対応）
- **ファイルサイズ**: 10MB以下に調整
- **破損チェック**: 他のアプリケーションで画像が正常に開けるか確認

#### JSONファイルの問題
- **JSON形式**: 有効なJSON形式で記述されているか確認
- **必須フィールド**: 各データ種別の必須フィールドが含まれているか確認
- **座標値**: imageX、imageYが数値形式で入力されているか確認

### 7.3 ジオリファレンスがうまくいかない

#### 制御点不足
- **最小要件**: 3点以上の一致ポイント
- **推奨**: 4点以上、理想的には6点以上
- **分布**: 画像全体に分散して配置

#### 座標精度の問題
- **GPS精度**: 10メートル以内の精度を確保
- **画像座標精度**: ピクセル単位での正確な位置指定
- **ID一致**: GPS データと画像内座標のポイントIDが完全に一致

#### 計算エラー
- **共線性**: 制御点が一直線上に配置されていないか確認
- **重複**: 同一座標の制御点が複数ないか確認
- **座標系**: WGS84座標系で統一されているか確認

### 7.4 出力ファイルの問題

#### ダウンロードできない
- **ブラウザ設定**: ダウンロード許可設定を確認
- **セキュリティ**: ポップアップブロック設定を確認
- **File System Access API**: 対応ブラウザ（Chrome 86+）の場合、権限許可

#### ファイル内容の問題
- **座標精度**: 出力座標がWGS84形式になっているか確認
- **属性情報**: 必要なプロパティが含まれているか確認
- **GeoJSON形式**: 有効なGeoJSON形式で出力されているか確認

## 8. よくある質問

### 8.1 一般的な質問

**Q: どのような画像が適していますか？**
A: ハイキングマップ、古地図、手描き地図など、地理的な特徴点（山頂、分岐点、建物等）が明確に識別できる画像が適しています。

**Q: GPS座標はどの程度の精度が必要ですか？**
A: 10メートル以内の精度を推奨します。スマートフォンのGPSでも、晴天時の屋外であれば十分な精度が得られます。

**Q: 制御点は最低何点必要ですか？**
A: 最低3点ですが、精度向上のため4点以上を推奨します。画像の四隅に近い位置に分散して配置することが理想的です。

### 8.2 技術的な質問

**Q: 対応している座標系は何ですか？**
A: 入力・出力ともにWGS84（緯度経度）のみ対応しています。内部計算はWeb Mercator投影を使用します。

**Q: オフラインで使用できますか？**
A: 地図データの読み込みにインターネット接続が必要です。完全オフラインでの使用はできません。

**Q: スマートフォンで使用できますか？**
A: 技術的には可能ですが、画面サイズやファイル操作の制約により、PC/タブレットでの使用を推奨します。

### 8.3 データ処理に関する質問

**Q: 大量のデータを処理できますか？**
A: Excel データは最大1000行、PNG画像は10MB程度までを推奨します。それ以上のデータは分割して処理してください。

**Q: 複数の画像を同時に処理できますか？**
A: 現在は1枚ずつの処理に対応しています。複数画像の場合は、個別に処理してください。

**Q: 出力されたGeoJSONファイルの用途は？**
A: GISソフトウェア（QGIS、ArcGIS等）での表示、Web地図での利用、他のアプリケーションとのデータ連携等に使用できます。

## 9. 制限事項

### 9.1 ファイル形式の制限
- **画像**: PNG形式のみ（JPEG、SVG等は未対応）
- **Excel**: .xlsx形式のみ（.xls、.csv等は未対応）
- **座標系**: WGS84のみ（JGD2011、UTM等は未対応）

### 9.2 サイズ・数量の制限
- **Excel行数**: 最大1000行
- **画像サイズ**: 推奨10MB以下
- **制御点数**: 最低3点、推奨4点以上

### 9.3 ブラウザ・環境の制限
- **ES6モジュール**: 対応ブラウザ必須
- **CORS制限**: ローカルサーバー必須
- **インターネット接続**: 地図データ読み込みに必要

### 9.4 精度の制限
- **変換精度**: 制御点の精度と数に依存
- **適用範囲**: アフィン変換（線形変換）のため、非線形歪みは補正不可
- **座標系変換**: WGS84 ↔ Web Mercator間のみ

---

## 付録

### A. 参考リンク
- **国土地理院**: https://www.gsi.go.jp/
- **GeoJSON仕様**: https://geojson.org/
- **Leaflet.js**: https://leafletjs.com/

### B. サポート情報
本アプリケーションに関するご質問・ご要望は、プロジェクトのIssueトラッカーまでお寄せください。

### C. 更新履歴
- **v1.0** (2025-09-12): 初版リリース
- **v1.1** (2025-09-20): リファクタリング版対応、操作性改善、精度向上

---

*この利用者の手引は、GeoReferencer v1.1（リファクタリング版）に基づいて作成されています。*