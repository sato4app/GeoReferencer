# GeoReferencer 利用者の手引

## はじめに

GeoReferencerは、ハイキングマップなどのPNG画像を国土地理院の地形図上に正確に重ね合わせるためのWebアプリケーションです。GPS座標データと画像ファイルを使用して、地理的に正確な位置合わせを行うことができます。

## 1. 準備

### 1.1 必要なファイル

GeoReferencerを使用するには、以下のファイルが必要です：

1. **GPS座標データ（GeoJSON形式）**
   - 地図上の基準点となるGPS座標
   - `.json`拡張子のGeoJSONファイル

2. **重ね合わせたい画像（PNG形式）**
   - ハイキングマップやその他の地図画像
   - `.png`拡張子のファイル

3. **画像内座標データ（JSON形式）**（任意）
   - 画像上のポイント、ルート、スポット情報
   - `.json`拡張子のファイル（複数可）

### 1.2 環境設定

1. **ローカルサーバーの起動**
   
   CORS制限を回避するため、ローカルHTTPサーバーを起動してください：
   
   ```bash
   # Python使用の場合
   python -m http.server 8000
   
   # Node.js使用の場合
   npx serve .
   ```

2. **ブラウザでアクセス**
   
   `http://localhost:8000`をブラウザで開いてください。

## 2. 基本的な使用方法

### 2.1 ファイル読み込み手順

#### ステップ1: GPS座標データの読み込み
1. 「ポイントGPS」ラジオボタンを選択
2. 「読み込み」ボタンをクリック
3. GeoJSONファイルを選択
4. 読み込まれたポイント数が表示されます

#### ステップ2: PNG画像の読み込み
1. 「PNG画像」ラジオボタンを選択  
2. 「読み込み」ボタンをクリック
3. PNGファイルを選択
4. 地図上に画像が初期位置で表示されます

#### ステップ3: 画像内座標の読み込み（任意）
1. 「画像内座標の読み込み」ボタンをクリック
2. 関連するJSONファイル（複数可）を選択
3. ポイント、ルート、スポットの数が表示されます

### 2.2 ジオリファレンス実行

#### ステップ4: 画像の重ね合わせ
1. 「画像の重ね合わせ（ジオリファレンス）」ボタンをクリック
2. システムが自動的に：
   - GPS座標と画像内座標の対応を検出
   - アフィン変換パラメータを計算
   - 画像を正確な地理位置に配置
   - 関連するマーカーの位置を更新

#### ステップ5: 結果の出力
1. 「座標をGPSに変換して出力(GeoJSON)」ボタンをクリック
2. 変換後の座標データがGeoJSON形式でダウンロードされます

## 3. データ形式詳細

### 3.1 GPS座標データ（GeoJSON）

```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [135.472041, 34.853667]
      },
      "properties": {
        "name": "箕面大滝",
        "id": "minoo_falls"
      }
    }
  ]
}
```

### 3.2 画像内座標データ

#### ポイントデータ
```json
{
  "points": [
    {
      "id": "point1",
      "name": "ポイント1",
      "imageX": 150,
      "imageY": 200,
      "lat": 34.853667,
      "lng": 135.472041
    }
  ]
}
```

#### ルートデータ
```json
{
  "name": "登山ルート1",
  "routeInfo": {
    "startPoint": "start1",
    "endPoint": "end1"
  },
  "points": [
    {
      "id": "start1",
      "name": "登山口",
      "lat": 34.850000,
      "lng": 135.470000,
      "imageX": 100,
      "imageY": 300,
      "type": "start"
    },
    {
      "id": "waypoint1", 
      "name": "中間点1",
      "lat": 34.852000,
      "lng": 135.471000,
      "imageX": 120,
      "imageY": 250,
      "type": "waypoint"
    },
    {
      "id": "end1",
      "name": "山頂",
      "lat": 34.854000,
      "lng": 135.472000,
      "imageX": 140,
      "imageY": 200,
      "type": "end"
    }
  ]
}
```

#### スポットデータ
```json
{
  "spots": [
    {
      "name": "展望台",
      "imageX": 200,
      "imageY": 150,
      "lat": 34.855000,
      "lng": 135.473000
    }
  ]
}
```

## 4. マーカーの見方

地図上に表示されるマーカーの意味：

### 4.1 ポイントマーカー
- **赤色円形**（半径6px）: 通常のGPSポイント
- **緑色円形**（半径7px）: ルートの開始点
- **赤色円形**（半径7px）: ルートの終了点  
- **オレンジ色ダイヤモンド型**（8×8px）: ルートの中間点

### 4.2 スポットマーカー
- **青色正方形**（10×10px）: スポット位置

### 4.3 ポップアップ情報
マーカーをクリックすると、以下の情報が表示されます：
- ポイント名・ID
- 座標情報（緯度・経度）
- ルート情報（該当する場合）
- ファイル名（読み込み元）

## 5. トラブルシューティング

### 5.1 よくある問題と解決方法

#### 問題: ファイルが読み込めない
**解決方法:**
- ファイル形式を確認（GPS座標: .json、画像: .png）
- JSONファイルの構文エラーがないか確認
- ローカルサーバーが起動していることを確認

#### 問題: 画像が表示されない
**解決方法:**
- PNGファイルが正しく選択されているか確認
- ファイルサイズが大きすぎないか確認
- ブラウザのコンソールでエラーメッセージを確認

#### 問題: ジオリファレンスが正確でない
**解決方法:**
- GPS座標データと画像内座標データの対応を確認
- 十分な数の基準点があることを確認（最低3点推奨）
- 基準点が画像全体に分散していることを確認

#### 問題: マーカーが表示されない
**解決方法:**
- JSONファイルの座標データを確認
- 座標が有効な範囲内にあることを確認
- ブラウザのズームレベルを調整

### 5.2 エラーメッセージ一覧

| エラーメッセージ | 原因 | 解決方法 |
|------------------|------|----------|
| "ファイル形式が正しくありません" | 対応外のファイル形式 | 指定された形式のファイルを使用 |
| "JSONファイルの解析に失敗しました" | JSON構文エラー | JSONの構文を確認・修正 |
| "対応するポイントが見つかりません" | 座標データの不一致 | GPS座標と画像内座標の対応を確認 |
| "変換パラメータの計算に失敗しました" | 基準点不足または不正 | より多くの基準点を追加 |

## 6. 使用例

### 6.1 ハイキングマップの重ね合わせ例

1. **準備するファイル**
   - `gps_points.json`: 登山口、山頂などの実際のGPS座標
   - `hiking_map.png`: ハイキングマップの画像
   - `map_points.json`: 画像上の対応する位置座標

2. **手順**
   1. GPS座標データを読み込み → 地図上に赤いマーカー表示
   2. ハイキングマップを読み込み → 初期位置で画像表示
   3. 画像内座標データを読み込み → 画像上のポイント表示
   4. ジオリファレンス実行 → 画像が正確な位置に移動
   5. 結果をGeoJSONで出力

3. **期待される結果**
   - ハイキングマップが地形図と正確に重なる
   - 登山ルートやスポットが正しい地理的位置に表示される
   - GPSデバイスでナビゲーション可能な座標データの取得

### 6.2 複数ルートの管理例

複数の登山ルートを同時に表示・管理する場合：

1. 各ルート用のJSONファイルを個別に作成
2. 「画像内座標の読み込み」で複数ファイルを一括選択
3. 異なる色・形状で各ルートが表示される
4. 統合されたGeoJSONファイルとして出力

## 7. 高度な機能

### 7.1 座標系について

- **入力座標系**: WGS84（GPS標準）
- **表示座標系**: Web Mercator（Leaflet標準）
- **変換**: 自動的に適切な座標系に変換

### 7.2 精度について

- **変換精度**: アフィン変換による高精度位置合わせ
- **評価指標**: 平均誤差、最大誤差を計算表示
- **推奨基準点数**: 最低3点、理想的には6点以上

### 7.3 データの永続化

- **ログ保存**: ブラウザのLocalStorageに処理ログを保存
- **設定保存**: 将来のバージョンで実装予定
- **作業の保存**: ブラウザリロード時は再読み込みが必要

## 8. 制限事項

### 8.1 ファイルサイズ制限
- 画像ファイル: ブラウザメモリ制限内
- JSONファイル: 実用的制限なし（ブラウザ性能に依存）

### 8.2 対応ファイル形式
- 画像: PNG形式のみ
- 座標データ: JSON/GeoJSON形式のみ
- Excel: 将来のバージョンで対応予定

### 8.3 ブラウザ要件
- ES6モジュール対応ブラウザが必要
- ローカルファイルアクセスのためHTTPサーバー経由でのアクセスが必要

## 9. サポート・お問い合わせ

### 9.1 技術情報
- **バージョン**: 1.0.0
- **最終更新**: 2024年09月
- **対応ブラウザ**: Chrome, Firefox, Safari, Edge（最新版）

### 9.2 関連資料
- 機能仕様書: `docs/funcspec.md`
- 開発者向けドキュメント: `CLAUDE.md`
- プロジェクト概要: `README.md`

---

この手引に記載されていない問題や疑問がありましたら、プロジェクトのドキュメントを参照するか、開発チームまでお問い合わせください。