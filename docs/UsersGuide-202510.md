# GeoReferencer 利用者の手引

## 目次
1. [はじめに](#1-はじめに)
2. [セットアップ](#2-セットアップ)
3. [基本的な使い方](#3-基本的な使い方)
4. [ファイル形式と準備](#4-ファイル形式と準備)
5. [操作手順](#5-操作手順)
6. [トラブルシューティング](#6-トラブルシューティング)
7. [よくある質問](#7-よくある質問)

---

## 1. はじめに

### 1.1 GeoReferencerとは
GeoReferencerは、PNG形式のハイキングマップなどの画像を国土地理院の地形図上に精密に重ね合わせる（ジオリファレンス）ためのWebアプリケーションです。

### 1.2 主な機能
- GPS座標データ（Excel/GeoJSON）の読み込みと地図表示
- PNG画像の読み込みとオーバーレイ表示
- 画像内座標データ（JSON）の読み込みと表示
- 精密アフィン変換による画像の自動位置合わせ
- 変換済み座標データのGeoJSON出力

### 1.3 利用シーン
- ハイキングマップをGPS座標と組み合わせて精密な位置情報を付与
- 古い地図や手書き地図をデジタル地図上に正確に配置
- ルート情報やスポット情報を地理的に正確な座標データに変換

---

## 2. セットアップ

### 2.1 必要な環境
- **ブラウザ**: Chrome 61+、Firefox 60+、Safari 10.1+
- **ローカルサーバー**: CORS制限回避のため必須

### 2.2 起動方法

#### Pythonを使う場合
```bash
# GeoReferencerフォルダに移動
cd GeoReferencer

# ローカルサーバーを起動
python -m http.server 8000

# ブラウザで以下のURLを開く
http://localhost:8000
```

#### Node.jsを使う場合
```bash
# GeoReferencerフォルダに移動
cd GeoReferencer

# serveをインストール（初回のみ）
npm install -g serve

# ローカルサーバーを起動
npx serve .

# ブラウザで表示されたURLを開く
```

### 2.3 初期画面
アプリケーションが起動すると、以下の要素が表示されます：
- 中央：国土地理院の地形図（初期位置：箕面大滝付近）
- 左上：操作パネル
- 右下：ズーム・スケールコントロール

---

## 3. 基本的な使い方

### 3.1 基本ワークフロー

```
1. GPS座標データ（Excel）を読み込む
   ↓
2. PNG画像を読み込む
   ↓
3. 画像内座標データ（JSON）を読み込む
   ↓
4. ジオリファレンス実行
   ↓
5. GPS出力（GeoJSON）
```

### 3.2 画面構成

#### 操作パネル（左上）
- **読み込みボタン**: ファイル読み込み用
- **ラジオボタン**: ファイル種別選択（ポイントGPS / PNG画像）
- **画像内座標の読み込みボタン**: JSONファイル読み込み
- **カウンター表示**: 読み込み済みデータの数量
- **ジオリファレンスボタン**: 画像の重ね合わせ実行
- **GPS出力ボタン**: GeoJSON形式でのデータ出力

---

## 4. ファイル形式と準備

### 4.1 GPS座標データ（Excel .xlsx）

#### 必須列
| 列名 | 型 | 説明 | 例 |
|------|-----|------|-----|
| 区分 | 文字列 | データ種別（「ポイント」のみ読み込まれます） | ポイント |
| ポイントID | 文字列 | 識別子（一意） | J-05 |
| 名称 | 文字列 | 地点名 | 東海道自然歩道 |
| 緯度 | 数値 | 緯度（-90～90） | 34.87202 |
| 経度 | 数値 | 経度（-180～180） | 135.49331 |

#### オプション列
| 列名 | 型 | 説明 | 例 |
|------|-----|------|-----|
| 標高 | 数値 | 標高（メートル） | 564.7 |
| 備考 | 文字列 | 補足情報 | （空欄可） |

#### 重要事項
- **「区分」列が必須**です。この列がないExcelファイルはエラーになります
- **「区分」列の値が「ポイント」の行のみ**が読み込まれます
- 「分岐点」「交差点」などの行は自動的に除外されます
- ヘッダー行（1行目）は必須です
- 最大1000行まで読み込み可能

#### サンプルExcelファイル
```
区分      | ポイントID | 名称              | 緯度      | 経度       | 標高  | 備考
---------|-----------|-------------------|-----------|-----------|-------|-----
ポイント  | J-05      | 東海道自然歩道     | 34.87202  | 135.49331 | 564.7 |
ポイント  | C-03      | 分岐点            | 34.86449  | 135.49353 | 520.0 |
分岐点    | X-01      | 交差点            | 34.86500  | 135.49400 | 530.0 | ← この行は読み込まれません
```

### 4.2 GPS座標データ（GeoJSON）

#### FeatureCollection形式
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "id": "J-05",
        "name": "東海道自然歩道"
      },
      "geometry": {
        "type": "Point",
        "coordinates": [135.49331, 34.87202, 564.7]
      }
    }
  ]
}
```

### 4.3 PNG画像ファイル
- **形式**: PNG形式のみ対応
- **推奨サイズ**: 10MB以下
- **内容**: ハイキングマップ、古地図、手書き地図など

### 4.4 画像内座標データ（JSON）

#### ポイントデータ
```json
{
  "points": [
    {
      "id": "J-05",
      "name": "東海道自然歩道",
      "imageX": 150,
      "imageY": 200
    }
  ]
}
```

#### ルートデータ
```json
{
  "routeInfo": {
    "startPoint": "C-03",
    "endPoint": "J-01"
  },
  "points": [
    {
      "type": "waypoint",
      "imageX": 150,
      "imageY": 200
    },
    {
      "type": "waypoint",
      "imageX": 170,
      "imageY": 220
    }
  ]
}
```

#### スポットデータ
```json
{
  "spots": [
    {
      "name": "薬師堂",
      "imageX": 300,
      "imageY": 400
    }
  ]
}
```

---

## 5. 操作手順

### 5.1 GPS座標データの読み込み

#### Excel形式の場合
1. **ラジオボタン**で「ポイントGPS」を選択（初期状態で選択済み）
2. **「読み込み」ボタン**をクリック
3. Excelファイル（.xlsx）を選択
4. 地図上に**緑色の円形マーカー**（GPSポイント）が表示されます
5. **「GPSポイント数」カウンター**に読み込み件数が表示されます

#### GeoJSON形式の場合
1. **ラジオボタン**で「ポイントGPS」を選択
2. **「読み込み」ボタン**をクリック
3. GeoJSONファイル（.geojson / .json）を選択
4. 地図上に**緑色の円形マーカー**が表示されます

#### 注意事項
- 「区分」列がないExcelファイルはエラーになります
- 「区分」が「ポイント」でない行は自動的に除外されます
- 標高データは自動的に数値型に変換されます

### 5.2 PNG画像の読み込み

1. **ラジオボタン**で「PNG画像」を選択
2. **「読み込み」ボタン**をクリック
3. PNG画像ファイルを選択
4. 地図上に画像が半透明でオーバーレイ表示されます
5. 画像は地図の中心に初期配置されます

### 5.3 画像内座標データの読み込み

1. **「画像内座標の読み込み」ボタン**をクリック
2. JSONファイルを選択（**複数選択可能**）
3. データが自動判定され、以下のように表示されます：
   - **ポイント**: 赤色円形マーカー
   - **ルート中間点**: オレンジ色ダイヤモンド型マーカー
   - **スポット**: 青色正方形マーカー
4. **カウンター**に各データの件数が表示されます

### 5.4 ジオリファレンス（画像の重ね合わせ）

1. すべてのデータ（GPS座標、PNG画像、画像内座標）を読み込みます
2. **「画像の重ね合わせ（ジオリファレンス）」ボタン**をクリック
3. 自動的に以下の処理が実行されます：
   - GPS座標と画像内座標のIDマッチング
   - 最小二乗法によるアフィン変換計算
   - 画像位置の自動調整
   - すべてのマーカー位置の同期更新
4. **マッチング結果**が表示されます：
   - 一致するポイント数
   - 不一致ポイント一覧
5. **精度情報**が表示されます：
   - 平均誤差（メートル）
   - 最大誤差（メートル）

#### ジオリファレンスの要件
- **最低3点**のマッチするポイントが必要（推奨4点以上）
- GPS座標のポイントIDと画像内座標のIDが一致している必要があります

### 5.5 GPS出力（GeoJSON）

1. ジオリファレンスを実行します
2. **「GPS出力(GeoJSON)」ボタン**をクリック
3. 保存ダイアログが表示されます：
   - ファイル名は自動生成されます（例：`地図名-GPS.geojson`）
   - 保存先を選択できます
4. GeoJSONファイルが保存されます

#### 出力されるデータ
- **ポイントGPS**: Excel/GeoJSONから読み込まれたGPS座標（標高は数値型）
- **ルート中間点**: 変換済みルート座標
- **スポット**: 変換済みスポット座標

---

## 6. トラブルシューティング

### 6.1 ファイル読み込みエラー

#### 「必須列「区分」が見つかりません」エラー
**原因**: Excelファイルに「区分」列がありません
**解決方法**:
- Excelファイルの1行目（ヘッダー行）に「区分」列を追加してください
- 「区分」列には「ポイント」という値を入力してください

#### 「ファイル種類が選択されていません」警告
**原因**: 内部エラー（通常は発生しません）
**解決方法**:
- ページをリロードして再試行してください
- それでも解決しない場合はブラウザのキャッシュをクリアしてください

#### 「Excel検証完了: 0行が有効」メッセージ
**原因**:
- 「区分」列の値がすべて「ポイント」以外になっています
- または必須列（ポイントID、名称、緯度、経度）にデータがありません

**解決方法**:
- 「区分」列の値を「ポイント」に修正してください
- 必須列にデータが入力されているか確認してください

#### 画像が読み込めない
**原因**: PNG形式以外のファイルを選択しています
**解決方法**: PNG形式の画像ファイルを選択してください

### 6.2 ジオリファレンスエラー

#### 「マッチするポイントが3点未満です」エラー
**原因**: GPS座標と画像内座標でIDが一致するポイントが3点未満です
**解決方法**:
- GPS座標のポイントIDと画像内座標のIDを確認してください
- 最低3点（推奨4点以上）のIDが一致している必要があります

#### 「ジオリファレンス済みデータがありません」エラー
**原因**: ジオリファレンスを実行していない状態でGPS出力しようとしました
**解決方法**:
- 先に「画像の重ね合わせ（ジオリファレンス）」ボタンをクリックしてください

#### 精度が低い（大きな誤差が表示される）
**原因**:
- 制御点が少なすぎる
- 制御点の配置が偏っている
- 画像の歪みが大きい

**解決方法**:
- 制御点を4点以上に増やしてください
- 制御点を画像全体に分散配置してください
- 画像の四隅付近に制御点を配置すると効果的です

### 6.3 GeoJSON出力エラー

#### 標高が文字列で出力される
**原因**: 古いバージョンのアプリケーションを使用しています
**解決方法**:
- ページをリロード（Ctrl+F5）してキャッシュをクリアしてください
- 最新版では標高は自動的に数値型に変換されます

#### ファイル保存ができない
**原因**: ブラウザがFile System Access APIに対応していません
**解決方法**:
- 自動的に従来のダウンロード方式にフォールバックします
- ブラウザのダウンロードフォルダを確認してください

### 6.4 表示エラー

#### マーカーが表示されない
**原因**:
- ファイル読み込みに失敗している
- 座標が地図の表示範囲外にある

**解決方法**:
- ブラウザのコンソール（F12キー）でエラーメッセージを確認してください
- 座標データの緯度・経度が正しい範囲内か確認してください
  - 緯度: -90～90
  - 経度: -180～180

#### 画像が表示されない
**原因**:
- PNG形式以外のファイルを読み込んでいる
- ファイルサイズが大きすぎる

**解決方法**:
- PNG形式の画像ファイルを使用してください
- ファイルサイズを10MB以下に縮小してください

---

## 7. よくある質問

### 7.1 データ準備について

#### Q1. ExcelファイルはどのOfficeバージョンで作成すればよいですか？
**A**: Excel 2007以降（.xlsx形式）であれば問題ありません。Googleスプレッドシートで作成したファイルも、Excel形式（.xlsx）でダウンロードすれば利用可能です。

#### Q2. 「区分」列は必須ですか？
**A**: はい、v1.3以降では**「区分」列が必須**です。この列がないExcelファイルはエラーになります。「区分」列の値が「ポイント」の行のみが読み込まれます。

#### Q3. GPS座標はどの座標系で準備すればよいですか？
**A**: **WGS84（EPSG:4326）の十進法（度）**で準備してください。例：緯度 34.87202、経度 135.49331

#### Q4. 画像内座標のimageX、imageYは何を基準にしますか？
**A**: 画像の左上を原点（0, 0）とし、右方向がX軸、下方向がY軸です。単位はピクセルです。

#### Q5. 標高データは必須ですか？
**A**: いいえ、標高データは**オプション**です。省略しても問題ありません。入力する場合は数値（メートル単位）で入力してください。文字列で入力しても自動的に数値型に変換されます。

### 7.2 操作について

#### Q6. 複数のJSONファイルを一度に読み込めますか？
**A**: はい、「画像内座標の読み込み」ボタンでは**複数のJSONファイルを同時選択**できます。ポイント・ルート・スポットが自動的に判別されます。

#### Q7. 制御点は何点必要ですか？
**A**: 最低**3点**必要ですが、**4点以上を推奨**します。制御点が多いほど、また全体に分散配置されているほど精度が向上します。

#### Q8. ジオリファレンス後に画像やデータを読み込み直せますか？
**A**: はい可能です。新しいファイルを読み込むと、以前のデータは上書きされます。再度ジオリファレンスを実行してください。

#### Q9. 出力されるGeoJSONファイルはどこで使えますか？
**A**: QGIS、ArcGIS、Leaflet、OpenLayersなど、GeoJSON形式に対応したGISソフトウェアやWeb地図ライブラリで利用できます。

### 7.3 エラーと制限について

#### Q10. なぜローカルサーバーが必要なのですか？
**A**: ブラウザのCORS（Cross-Origin Resource Sharing）制限により、ファイルシステムから直接HTMLファイルを開くとES6モジュールが読み込めません。ローカルサーバー経由でアクセスすることでこの制限を回避します。

#### Q11. Excelファイルの最大行数はどのくらいですか？
**A**: **最大1000行**まで読み込み可能です（ヘッダー行を除く）。それ以上のデータは自動的に切り捨てられます。

#### Q12. JPEGやGIF画像は使えますか？
**A**: いいえ、現在は**PNG形式のみ**対応しています。JPEGやGIF画像を使用する場合は、事前にPNG形式に変換してください。

### 7.4 出力について

#### Q13. 出力されるGeoJSONファイルの座標系は何ですか？
**A**: **WGS84（EPSG:4326）**です。GeoJSON標準仕様に準拠しています。

#### Q14. 出力ファイル名は変更できますか？
**A**: はい、保存ダイアログで任意のファイル名に変更できます。デフォルトでは「{PNG画像名}-GPS.geojson」の形式で自動生成されます。

#### Q15. 標高が「"564.7"」のように文字列で出力されるのはなぜですか？
**A**: 古いバージョン（v1.2以前）では標高が文字列型で出力されていました。v1.3以降では自動的に**数値型に変換**されるため、「564.7」のように数値として出力されます。ページをリロード（Ctrl+F5）して最新版を使用してください。

### 7.5 技術的な質問

#### Q16. オフラインで使用できますか？
**A**: 地図タイルは国土地理院のサーバーから取得するため、**インターネット接続が必要**です。ただし、データ処理自体はブラウザ内で完結します。

#### Q17. スマートフォンやタブレットで使えますか？
**A**: 技術的には可能ですが、操作性の観点から**PCでの使用を推奨**します。

#### Q18. データのプライバシーは保護されますか？
**A**: はい、すべてのデータ処理は**ブラウザ内**で完結し、外部サーバーにデータが送信されることはありません（地図タイルの取得を除く）。

---

## 付録

### A. ショートカットキー
- **ESC**: エラーメッセージを閉じる

### B. ブラウザコンソールの確認方法
詳細なエラー情報を確認する場合：
1. **F12キー**を押す（Macは Cmd+Option+I）
2. **Console**タブを選択
3. エラーメッセージや警告を確認

### C. サポート情報
- **機能仕様書**: `docs/funcspec-202510.md`
- **GeoJSON仕様**: `docs/geojsonSpec-202510.md`
- **プロジェクト仕様**: `CLAUDE.md`

---

## 改訂履歴
- **v1.0** (2025-09-12): 初版リリース
- **v1.1** (2025-09-20): リファクタリング版対応
- **v1.2** (2025-09-28): GeoJSON出力仕様準拠版対応
- **v1.3** (2025-10-26): Excel「区分」列フィルタリング、標高数値型変換対応
