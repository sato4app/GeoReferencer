# GeoReferencer 利用者の手引

## 目次
1. [はじめに](#1-はじめに)
2. [セットアップ](#2-セットアップ)
3. [基本操作](#3-基本操作)
4. [詳細機能](#4-詳細機能)
5. [トラブルシューティング](#5-トラブルシューティング)
6. [よくある質問](#6-よくある質問)

---

## 1. はじめに

### 1.1 GeoReferencerとは
GeoReferencerは、PNG形式のハイキングマップや登山地図などの画像を、国土地理院の地形図上に正確に重ね合わせるWebアプリケーションです。画像内の主要ポイント、ルート、スポット情報をGPS座標に変換し、クラウドで管理することができます。

### 1.2 主な用途
- ハイキングマップ・登山地図のデジタル化
- 画像地図のGPS座標変換
- ルート・スポット情報のデータベース管理
- 標高データの取得・管理

### 1.3 必要なもの
- **Webブラウザ**: Chrome、Firefox、Safari(ES6モジュール対応ブラウザ)
- **ローカルサーバー**: Python、Node.js等
- **入力ファイル**:
  - PNG画像ファイル(地図画像)
  - Excelファイル(.xlsx形式) - GPS座標データ

### 1.4 できること・できないこと

#### できること ✅
- PNG画像を地理院地図上に重ね合わせ
- 画像内座標をGPS座標に変換
- ポイント・ルート・スポットのデータベース管理(Firebase)
- 標高データの自動取得
- データの保存・読み込み(クラウド)

#### できないこと ❌
- JPEG、GIF、SVG等のPNG以外の画像形式
- GeoJSONファイルの出力(現在未実装)
- 座標系変換(JGD2011等)
- オフラインでの動作

---

## 2. セットアップ

### 2.1 ローカルサーバーの起動

GeoReferencerはES6モジュールを使用しているため、ローカルサーバーが必要です。

#### Pythonを使う場合
```bash
# Pythonがインストールされていることを確認
python --version

# GeoReferencerフォルダに移動
cd /path/to/GeoReferencer

# ローカルサーバー起動(ポート8000)
python -m http.server 8000
```

#### Node.jsを使う場合
```bash
# npxコマンドでserveを起動
npx serve .
```

### 2.2 ブラウザでアクセス

ローカルサーバー起動後、ブラウザで以下のURLにアクセス:
```
http://localhost:8000
```

### 2.3 初期画面

アプリケーションが正常に起動すると、以下が表示されます:
- 国土地理院の地形図(箕面大滝周辺)
- 左上の操作パネル
- 右下のズームコントロール・スケールバー

---

## 3. 基本操作

### 3.1 基本ワークフロー

```
1. PNG画像を読み込む
   ↓
2. (自動) Firebaseから画像内座標データを読み込む
   ↓
3. GPS座標データ(Excel)を読み込む
   ↓
4. ジオリファレンス(画像の重ね合わせ)を実行
   ↓
5. GPS変換済みデータをFirebaseに保存
   ↓
6. 標高データを取得
```

### 3.2 PNG画像の読み込み

#### 操作手順
1. 左上の操作パネルで「**PNG画像の読み込み**」ボタンをクリック
2. PNG画像ファイルを選択
3. 画像が地図上に表示される

#### 自動実行される処理
- Firebaseから画像内座標データを自動読み込み
  - ポイント(画像座標)
  - ルート(画像座標)
  - スポット(画像座標)
- カウンターが更新される:
  - ポイント数
  - ルート数
  - スポット数

#### 注意事項
- PNG形式のみ対応(JPEG等は不可)
- ファイル名から拡張子を除いた部分がプロジェクトIDとなる
- 初回読み込み時はFirebaseにデータがないため、カウンターは0件

### 3.3 GPS座標データ(Excel)の読み込み

#### 操作手順
1. 左上の操作パネルで「**ポイントGPSの読み込み**」ボタンをクリック
2. Excelファイル(.xlsx)を選択
3. GPS座標データが地図上に緑色のマーカーで表示される

#### Excelファイルの形式
必須列:
| 列名 | 説明 | 例 |
|------|------|-----|
| ポイントID | A-01形式のID | A-01 |
| 名称 | ポイント名 | 箕面大滝 |
| 緯度 | 緯度(10進数) | 34.853667 |
| 経度 | 経度(10進数) | 135.472041 |

オプション列:
| 列名 | 説明 | 例 |
|------|------|-----|
| 標高 | 標高(メートル) | 450 |
| 備考 | 備考 | 滝の展望台 |

#### 注意事項
- 最大1000行まで読み込み可能
- ポイントIDは「A-01」形式(大文字1文字 + ハイフン + 2桁数字)
- 緯度・経度は10進数形式で入力

### 3.4 ジオリファレンス(画像の重ね合わせ)

#### 操作手順
1. PNG画像とGPS座標データが両方読み込まれていることを確認
2. 「**画像の重ね合わせ(ジオリファレンス)**」ボタンをクリック
3. 自動的に以下が実行される:
   - ポイントIDマッチング
   - アフィン変換計算
   - 画像位置の調整
   - ルート・スポット座標のGPS変換

#### 結果の確認
- **一致するポイント数**: マッチングに成功したポイント数
- **不一致ポイント**: マッチングに失敗したポイントID
- 画像が地図上に正確に重ね合わせられる
- ルート中間点・スポットがGPS座標で表示される

#### 注意事項
- 最低3点以上のポイントマッチングが必要(推奨4点以上)
- ポイントIDが一致しないとマッチングできない
- マッチング精度は制御点の数と配置に依存

### 3.5 GPS変換済みデータの保存

#### 操作手順
1. ジオリファレンスが完了していることを確認
2. 「**変換後のGPS値をデータベースに格納**」ボタンをクリック
3. Firebaseに以下のデータが保存される:
   - GPS変換済みポイント
   - GPS変換済みルート(中間点)
   - GPS変換済みスポット

#### 保存されるデータ
- **ポイント**: ID、名称、GPS座標(経度、緯度、標高)
- **ルート**: ルート名、開始ポイント、終了ポイント、中間点GPS座標配列
- **スポット**: 名称、GPS座標(経度、緯度、標高)

#### 注意事項
- 既存データは上書きされる
- 標高は後から取得可能(nullで保存される)

### 3.6 標高データの取得

#### 操作手順
1. GPS変換済みデータがFirebaseに保存されていることを確認
2. 取得対象をチェックボックスで選択:
   - ☑ ルート中間点
   - ☑ スポット
3. 「**標高取得**」ボタンをクリック
4. 国土地理院APIから標高データを取得(0.5秒/件)

#### 進捗の確認
- **標高未取得数**: リアルタイムで減少
- **メッセージエリア**: 「標高取得完了: 成功XX件、失敗XX件」

#### 注意事項
- 標高取得には時間がかかる(1件あたり0.5秒)
- 既に標高が設定されているものはスキップ
- 国土地理院APIのレート制限に対応

---

## 4. 詳細機能

### 4.1 マーカーの種類と色

地図上に表示されるマーカーは以下の種類があります:

| マーカー種類 | 色・形状 | 説明 |
|-------------|---------|------|
| GPSポイント | 緑色円形(大) | GPS座標データ(Excel)から読み込んだポイント |
| ポイントマーカー | 赤色円形(小) | Firebaseから読み込んだ画像内ポイント |
| ルート中間点 | オレンジ色ダイヤモンド | GPS変換済みルート中間点 |
| スポット | 青色正方形 | GPS変換済みスポット |

### 4.2 座標系について

GeoReferencerでは以下の座標系を使用します:

#### 入力座標系
- **画像座標**: PNG画像のピクセル座標(x, y)
- **GPS座標**: WGS84座標系(緯度、経度)

#### 内部処理
- **Web Mercator投影**: アフィン変換の計算に使用

#### 出力座標系
- **GPS座標**: WGS84座標系(経度、緯度、標高)

### 4.3 アフィン変換の精度

#### 精度に影響する要素
1. **制御点数**: 3点以上(推奨4点以上)
2. **制御点の配置**: 画像の四隅に配置すると精度向上
3. **GPS座標の精度**: 正確な座標が必要

#### 精度評価指標
- **平均誤差**: 全制御点の平均誤差(メートル)
- **最大誤差**: 最も大きい誤差(メートル)
- **最小誤差**: 最も小さい誤差(メートル)

### 4.4 Firebaseデータ構造

#### プロジェクト管理
- **プロジェクトID**: PNG画像ファイル名(拡張子なし)
- **共有設定**: 認証済みユーザー全員がアクセス可能

#### データ階層
```
projects/{projectId}/
  ├── (プロジェクトメタデータ)
  ├── points/          # 画像内ポイント座標
  ├── routes/          # 画像内ルート座標
  ├── spots/           # 画像内スポット座標
  ├── gpsPoints/       # GPS変換済みポイント
  ├── gpsRoutes/       # GPS変換済みルート
  └── gpsSpots/        # GPS変換済みスポット
```

詳細は `docs/firebase-dbspec-202512.md` を参照

---

## 5. トラブルシューティング

### 5.1 画面が真っ白で何も表示されない

#### 原因
- ローカルサーバーが起動していない
- CORS制限によるエラー

#### 解決方法
```bash
# ローカルサーバーを起動
python -m http.server 8000

# ブラウザで http://localhost:8000 にアクセス
```

### 5.2 「Firebase接続が利用できません」エラー

#### 原因
- Firebaseの初期化に失敗
- ネットワーク接続の問題

#### 解決方法
1. インターネット接続を確認
2. ブラウザのコンソールでエラーログを確認
3. ページをリロード

### 5.3 PNG画像が読み込めない

#### 原因
- ファイル形式がPNGでない
- ファイルサイズが大きすぎる

#### 解決方法
1. ファイル形式を確認(.png拡張子)
2. 画像サイズを縮小(推奨10MB以下)
3. 画像編集ソフトでPNG形式に変換

### 5.4 GPS座標データ(Excel)が読み込めない

#### 原因
- 必須列が不足
- データ形式が不正
- ファイルサイズが大きすぎる

#### 解決方法
1. 必須列を確認:
   - ポイントID
   - 名称
   - 緯度
   - 経度
2. ポイントIDの形式を確認(例: A-01)
3. 緯度・経度が10進数形式であることを確認
4. 行数を1000行以下に削減

### 5.5 ジオリファレンスが実行できない

#### 原因
- PNG画像が読み込まれていない
- GPS座標データが読み込まれていない
- マッチングポイントが3点未満

#### 解決方法
1. PNG画像とGPS座標データの両方が読み込まれていることを確認
2. 「一致するポイント数」が3以上であることを確認
3. ポイントIDが正確に一致していることを確認

### 5.6 標高取得が失敗する

#### 原因
- 国土地理院APIの制限
- ネットワーク接続の問題
- 座標が日本国外

#### 解決方法
1. 国土地理院APIは日本国内の座標のみ対応
2. ネットワーク接続を確認
3. 時間を置いて再実行

---

## 6. よくある質問

### Q1. オフラインで使用できますか？
**A**: いいえ、以下の理由によりオンライン環境が必要です:
- 国土地理院の地図タイルの読み込み
- Firebaseとの通信
- 標高データの取得

### Q2. 複数のプロジェクトを管理できますか？
**A**: はい、PNG画像ファイル名がプロジェクトIDとなるため、異なるファイル名で複数のプロジェクトを管理できます。

### Q3. データは誰でもアクセスできますか？
**A**: 匿名認証されたユーザーのみアクセス可能です。ただし、プロジェクトIDが分かればデータを読み書きできるため、機密性の高いデータには不向きです。

### Q4. JPEG形式の画像は使えますか？
**A**: いいえ、現在PNG形式のみ対応しています。画像編集ソフトでPNG形式に変換してください。

### Q5. 座標系JGD2011に対応していますか？
**A**: いいえ、現在WGS84座標系のみ対応しています。

### Q6. データをエクスポートできますか？
**A**: 現在GeoJSON形式でのエクスポート機能は未実装です。将来のバージョンで対応予定です。

### Q7. 標高データはどこから取得していますか？
**A**: 国土地理院の標高APIから取得しています。精度は地域により異なりますが、5mメッシュ(レーザ)または10mメッシュです。

### Q8. ルートは複数作成できますか？
**A**: Firebaseには複数ルートを保存できますが、現在のUIは1ルートのみ表示します。将来のバージョンで対応予定です。

### Q9. スマートフォンで使えますか？
**A**: ブラウザがES6モジュールに対応していれば使用可能ですが、PC推奨です。

### Q10. データのバックアップは必要ですか？
**A**: Firebaseに保存されるため基本的には不要ですが、重要なデータは定期的にバックアップすることを推奨します。

---

## 7. 補足資料

### 7.1 関連ドキュメント
- [機能仕様書](funcspec-202512.md) - 技術的な詳細仕様
- [Firebase DB仕様書](firebase-dbspec-202512.md) - データベース構造の詳細

### 7.2 お問い合わせ
- 不具合報告: GitHubリポジトリのIssue
- 機能要望: GitHubリポジトリのIssue

---

**作成日**: 2025年12月1日
**バージョン**: 1.0
**対象アプリケーション**: GeoReferencer v1.0
