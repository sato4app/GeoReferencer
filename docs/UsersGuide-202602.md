# GeoReferencer 利用者の手引 (v2.0)

## 目次
1. [はじめに](#1-はじめに)
2. [セットアップ](#2-セットアップ)
3. [基本操作](#3-基本操作)
4. [詳細機能](#4-詳細機能)
5. [トラブルシューティング](#5-トラブルシューティング)
6. [よくある質問](#6-よくある質問)

---

## 1. はじめに

### 1.1 GeoReferencerとは
GeoReferencerは、PNG形式のハイキングマップや登山地図などの画像を、国土地理院の地形図上に正確に重ね合わせるWebアプリケーションです。画像内の主要ポイント、ルート、スポット情報をGPS座標に変換し、GeoJSONなどでエクスポートして他のGISソフトで利用することができます。

**v2.0の大きな変更点は、クラウド（Firebase）依存を撤廃し、完全にユーザーのローカル環境でデータを扱えるようになったことです。**

### 1.2 主な用途
- ハイキングマップ・登山地図のデジタル化
- 画像地図のGPS座標変換
- ルート・スポット情報のGeoJSON化
- 標高データの取得・付与

### 1.3 必要なもの
- **Webブラウザ**: Chrome、Firefox、Safari (ES6モジュール対応ブラウザ)
- **入力ファイル**:
  - PNG画像ファイル（地図画像）
  - Excelファイル (.xlsx形式) - 基準となるGPS座標データ
  - (任意) JSONファイル - 画像上のルート・スポット定義

### 1.4 できること・できないこと

#### できること ✅
- PNG画像を地理院地図上に重ね合わせ
- 画像内座標をGPS座標に変換（ジオリファレンス）
- 変換済みデータのGeoJSONエクスポート
- 国土地理院APIからの標高データ自動取得
- 完全ローカル動作（通信は地図タイル・標高APIのみ）

#### できないこと ❌
- JPEG、GIF、SVG等のPNG以外の画像形式
- 複数人でのリアルタイム同時編集（クラウド機能削除のため）
- 座標系変換（JGD2011等への対応は未実装）

---

## 2. セットアップ

### 2.1 ローカルサーバーの起動
本アプリはES6モジュールを使用しているため、ブラウザで直接ファイルを開くのではなく、ローカルサーバー経由でアクセスする必要があります。

#### Pythonを使う場合
```bash
# GeoReferencerフォルダに移動
cd /path/to/GeoReferencer

# ローカルサーバー起動
python -m http.server 8000
```

#### Node.jsを使う場合
```bash
npx serve .
```

### 2.2 ブラウザでアクセス
ローカルサーバー起動後、ブラウザで以下のURLにアクセスします。
```
http://localhost:8000
```
正常に起動すると、国土地理院の地図が表示されます。

---

## 3. 基本操作

### 3.1 基本ワークフロー

1. **PNG画像を読み込む**（地図の背景画像）
2. **ポイントGPSデータを読み込む**（Excelファイル）
3. **(任意) JSONデータを読み込む**（画像上のポイント・ルート・スポット定義）
4. **ジオリファレンスを実行**（画像の重ね合わせと座標変換）
5. **(任意) 標高データを取得**
6. **GeoJSONをエクスポート**（保存）

### 3.2 PNG画像の読み込み
1. 操作パネルの「**PNG画像**」ラジオボタンを選択または「読み込み」ボタンから画像ロード。
2. ファイル選択ダイアログでPNG画像を選びます。
3. 地図上に画像が表示されます。

### 3.3 ポイントGPS（Excel）の読み込み
1. 「**ポイントGPS**」ラジオボタンを選択し「読み込み」。
2. Excelファイル (.xlsx) を選択します。
3. 地図上に緑色のマーカー（基準点）が表示されます。

**Excelファイルの形式（必須列）**:
| 列名 | 説明 | 例 |
|------|------|-----|
| ポイントID | 固有ID | A-01 |
| 名称 | 地点名 | 山頂A |
| 緯度 | 十進法 | 35.123456 |
| 経度 | 十進法 | 139.654321 |

### 3.4 JSONデータの読み込み（任意）
あらかじめ画像上の座標定義（ルートやスポット）がある場合、JSONファイルを読み込むことでそれらを地図上に展開できます。
「**JSONファイル**」ラジオボタンを選択して読み込みます。
読み込み完了後、画面上部に「ポイント: X個, ルート: Y本...」といった詳細な件数が表示されます。

### 3.5 ジオリファレンス（画像の重ね合わせ）
1. 画像とGPSデータの両方が読み込まれていることを確認します。
2. 「**画像の重ね合わせ（ジオリファレンス）**」ボタンをクリック。
3. ポイントIDのマッチングが行われ、画像が地図に合わせて変形・移動します。
4. 結果（一致数、誤差）が表示されます。精度を高めるため、最低3点以上のマッチングが必要です。

### 3.6 標高データの取得
1. ジオリファレンス完了後、「**標高取得**」ボタンが有効になります。
2. 取得したい対象（ルート中間点、スポットなど）にチェックを入れます。
3. ボタンをクリックすると、国土地理院APIから標高を順次取得します（0.5秒/件）。

### 3.7 GeoJSONのエクスポート
1. 全ての作業が完了したら、「**変換後のGPS値をGeoJSONファイルに保存**」ボタン（または保存ボタン）をクリック。
2. `[画像名略称]-GPS-[YYYYMMDD].json` のようなファイル名（例: `map-GPS-20260214.json`）でダウンロードされます。
3. このファイルは、QGISや他のWeb地図アプリで利用可能です。

---

## 4. 詳細機能

### 4.1 マーカーの種類
- **緑色円形**: GPS基準点（Excel由来）
- **赤色円形**: 画像上のポイント（JSON由来）
- **オレンジ色**: ルート中間点
- **青色**: スポット

### 4.2 アフィン変換と精度
- **変換方式**: 6パラメータアフィン変換（平行移動、回転、拡大縮小、剪断）
- **精度評価**: 各ポイントの残差（メートル単位）を表示します。誤差が大きい場合は、ポイント位置やIDの誤りを疑ってください。

---

## 5. トラブルシューティング

### 5.1 画像が表示されない
- PNG形式であることを確認してください。
- ファイルサイズが大きすぎる場合（数十MB以上）、ブラウザのメモリ制限にかかることがあります。

### 5.2 標高取得が遅い/進まない
- 国土地理院APIへの負荷を避けるため、意図的にウェイト（0.5秒）を入れています。
- ネットワーク接続を確認してください。

### 5.3 マッチングしない
- Excelの「ポイントID」と、画像上（JSON）の「ID」が完全一致しているか確認してください（全角半角、スペースなど）。

---

## 6. よくある質問

**Q: クラウドに保存されますか？**
A: いいえ。v2.0からはクラウド保存機能は削除されました。全てのデータはお使いのPC内に保存（ダウンロード）されます。

**Q: オフラインで使えますか？**
A: 地図タイル（国土地理院）の表示にはインターネット接続が必要です。ただし、ローカルサーバーが動いていればアプリ自体の起動は可能です。

**Q: 以前のFirebaseデータはどうなりますか？**
A: 本バージョンではFirebaseへのアクセス機能自体が削除されているため、過去のクラウドデータは読み込めません。必要に応じて旧バージョンを利用するか、データをエクスポートして移行してください。

---
**作成日**: 2026年2月13日
**バージョン**: 2.0
